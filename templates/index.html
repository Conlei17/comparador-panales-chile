<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ titulo_pagina }}</title>
  <meta name="description" content="{{ meta_descripcion }}">
  <link rel="canonical" href="{{ canonical_url }}">
  <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='favicon-32x32.png') }}">
  <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
  <meta name="theme-color" content="#f4b8a8">

  <!-- Open Graph: preview al compartir por WhatsApp, redes sociales, etc -->
  <meta property="og:type" content="website">
  <meta property="og:title" content="{{ titulo_pagina }}">
  <meta property="og:description" content="{{ meta_descripcion }}">
  <meta property="og:image" content="{{ url_for('static', filename='og-image.png', _external=True) }}">
  <meta property="og:url" content="{{ canonical_url }}">

  <!-- Twitter Cards -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="{{ titulo_pagina }}">
  <meta name="twitter:description" content="{{ meta_descripcion }}">

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-H2K7K5G7C2"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-H2K7K5G7C2');
  </script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Nunito:wght@600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <script>
    // Apply dark mode before render to avoid flash
    if (localStorage.getItem('darkMode') === 'true') {
      document.documentElement.style.visibility = 'hidden';
    }
  </script>

  <!-- Schema.org JSON-LD -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebSite",
    "name": "BabyAhorro",
    "url": "{{ request.url_root }}",
    "description": "Comparador de precios de panales, toallitas y formulas infantiles en Chile"
  }
  </script>
  {% if hay_filtro and productos %}
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "ItemList",
    "itemListElement": [
      {% for p in productos[:5] %}
      {
        "@type": "ListItem",
        "position": {{ loop.index }},
        "item": {
          "@type": "Product",
          "name": "{{ p.nombre|e }}",
          "brand": {"@type": "Brand", "name": "{{ p.marca_normalizada|e }}"},
          {% if p.imagen_url %}"image": "{{ p.imagen_url }}",{% endif %}
          "offers": {
            "@type": "Offer",
            "price": "{{ p.precio }}",
            "priceCurrency": "CLP",
            "availability": "https://schema.org/InStock",
            "seller": {"@type": "Organization", "name": "{{ p.tienda|e }}"}
          }
        }
      }{{ "," if not loop.last else "" }}
      {% endfor %}
    ]
  }
  </script>
  {% endif %}
</head>
<body>

  <script>
    if (localStorage.getItem('darkMode') === 'true') {
      document.body.classList.add('dark');
      document.documentElement.style.visibility = '';
    }
  </script>

  <!-- Header -->
  <header class="header">
    <button class="dark-toggle" onclick="toggleDark()" title="Cambiar tema" id="darkToggle">&#9790;</button>
    <img src="{{ url_for('static', filename='logo.png') }}" alt="BabyAhorro" class="header-logo">
    <p class="header-tagline">Ahorro real para familias reales</p>
    <nav class="nav">
      <a href="/" class="nav-link nav-link--active">Comparar precios</a>
      <a href="/historico" class="nav-link">Hist&oacute;rico</a>
    </nav>
  </header>

  <div class="container">

    <!-- Busquedas recientes (fuera del form, como accesos directos) -->
    <div class="busquedas-recientes" id="busquedasRecientes" style="display:none;"></div>

    <!-- Filtros -->
    <form class="filtros" method="GET" action="/" id="formBuscar">
      <h1 class="h1-buscador">Comparador de precios de panales en Chile</h1>

      <!-- Fila de filtros principales -->
      <div class="filtros-grid">
        <div class="filtro-grupo">
          <label for="categoria">Categoria</label>
          <select name="categoria" id="categoria">
            <option value="">Todas</option>
            <option value="Pa&ntilde;ales" {% if categoria_sel == 'Pañales' %}selected{% endif %}>Pa&ntilde;ales</option>
            <option value="Pa&ntilde;ales de Agua" {% if categoria_sel == 'Pañales de Agua' %}selected{% endif %}>Pa&ntilde;ales de Agua</option>
            <option value="Toallitas Humedas" {% if categoria_sel == 'Toallitas Humedas' %}selected{% endif %}>Toallitas H&uacute;medas</option>
            <option value="Fórmulas Infantiles" {% if categoria_sel == 'Fórmulas Infantiles' %}selected{% endif %}>F&oacute;rmulas Infantiles</option>
          </select>
        </div>

        <div class="filtro-grupo">
          <label for="marca">Marca</label>
          <select name="marca" id="marca">
            <option value="">Todas las marcas</option>
            {% for marca in marcas %}
              <option value="{{ marca }}" {% if marca == marca_sel %}selected{% endif %}>
                {{ marca }}
              </option>
            {% endfor %}
          </select>
        </div>

        <div class="filtro-grupo" id="tallaGrupo">
          <label for="talla">Talla</label>
          <select name="talla" id="talla">
            <option value="">Todas las tallas</option>
            {% for talla in tallas %}
              <option value="{{ talla }}" {% if talla == talla_sel %}selected{% endif %}>
                {{ talla }}
              </option>
            {% endfor %}
          </select>
        </div>

        <div class="filtro-grupo" id="productoGrupo" style="display:none">
          <label for="producto">Producto</label>
          <select name="producto" id="producto">
            <option value="">Todos los productos</option>
          </select>
        </div>

        <div class="filtro-botones">
          <button type="submit" class="btn-buscar">Buscar</button>
          <a href="/" class="btn-limpiar {{ '' if hay_filtro else 'btn-limpiar--disabled' }}">Limpiar</a>
        </div>
      </div>

      <!-- Tiendas (chips visibles) -->
      <div class="filtro-tiendas-section">
        <div class="filtro-tiendas-header">
          <label>Tiendas</label>
          <div class="tiendas-quick-links">
            <a onclick="seleccionarTiendas(true)">Todas</a>
            <span class="tiendas-sep">|</span>
            <a onclick="seleccionarTiendas(false)">Ninguna</a>
          </div>
        </div>
        <div class="checkbox-grupo" id="tiendasGrupo">
          {% for tienda in tiendas %}
          <label class="checkbox-label">
            <input type="checkbox" name="tiendas" value="{{ tienda }}"
                   {% if tienda in tiendas_sel or not tiendas_sel %}checked{% endif %}>
            <span class="chip">{{ tienda }}</span>
          </label>
          {% endfor %}
        </div>
      </div>

      <!-- Filtros avanzados (colapsables) -->
      <details class="filtros-avanzados">
        <summary>Filtros avanzados</summary>
        <div class="filtros-avanzados-body">

          <!-- Precio maximo -->
          <div class="filtro-slider">
            <label for="precio_max">
              Precio maximo del paquete:
              <span id="precio_max_label" class="slider-value">
                {% if precio_max %}
                  ${{ "{:,}".format(precio_max).replace(",", ".") }}
                {% else %}
                  Sin limite
                {% endif %}
              </span>
            </label>
            <input type="range" name="precio_max" id="precio_max"
                   min="1000" max="{{ precio_max_global }}" step="1000"
                   value="{{ precio_max or precio_max_global }}"
                   oninput="actualizarSlider(this.value)">
            <div class="slider-rango">
              <span>$1.000</span>
              <span>${{ "{:,}".format(precio_max_global).replace(",", ".") }}</span>
            </div>
          </div>

        </div>
      </details>

      {% if ultima_fecha %}
        <div class="filtros-fecha">Precios actualizados el {{ ultima_fecha[:10] }}</div>
      {% endif %}
    </form>

    <!-- Info + Top por talla (bloque cohesionado) -->
    {% if hay_filtro %}
    <div class="info-panel">
      <div class="info-bar">
        <span class="total">{{ total }} producto{{ 's' if total != 1 else '' }} encontrado{{ 's' if total != 1 else '' }}</span>
        <div class="info-bar-right">
          <button class="btn-compartir" onclick="compartirBusqueda(this)" title="Copiar link de esta busqueda">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/></svg>
            <span class="btn-compartir-texto">Compartir</span>
          </button>
          {% if ultima_fecha %}
            <span class="info-fecha">{{ ultima_fecha[:10] }}</span>
          {% endif %}
        </div>
      </div>

      {% if top_por_talla %}
      <div class="top-tallas-section">
        <div class="top-tallas-titulo">Mejor precio por talla</div>
        <div class="top-tallas-scroll">
          <div class="top-tallas">
            {% for talla, prod in top_por_talla.items() %}
            {% set _url_amigable = construir_url_amigable(categoria=categoria_sel or None, marca=marca_sel or None, talla=talla) %}
            <a href="{{ _url_amigable if _url_amigable else '/?talla=' ~ talla ~ ('&marca=' ~ marca_sel if marca_sel else '') ~ ('&categoria=' ~ categoria_sel if categoria_sel else '') }}" class="top-talla-card">
              <span class="top-talla-size">{{ talla }}</span>
              <span class="top-talla-nombre" title="{{ prod.nombre }}">{{ prod.nombre }}</span>
              <div class="top-talla-meta">
                <span class="top-talla-ppu">{{ prod.precio_por_unidad|precio }}/u</span>
                <span class="top-talla-tienda">{{ prod.tienda }}</span>
              </div>
            </a>
            {% endfor %}
          </div>
        </div>
      </div>
      {% endif %}
    </div>
    {% endif %}

    <!-- Seccion de ahorro -->
    {% if ahorro %}
    <div class="ahorro-card">
      <div class="ahorro-header">Consejo de ahorro</div>
      <div class="ahorro-body">
        <div class="ahorro-comparacion">
          <div class="ahorro-item ahorro-mejor">
            <span class="ahorro-etiqueta">Mejor precio</span>
            <span class="ahorro-precio">{{ ahorro.mejor.precio_por_unidad|precio }}/u</span>
            <span class="ahorro-nombre">{{ ahorro.mejor.nombre }}</span>
            <span class="ahorro-tienda">{{ ahorro.mejor.tienda }}</span>
          </div>
          <div class="ahorro-vs">vs</div>
          <div class="ahorro-item ahorro-peor">
            <span class="ahorro-etiqueta">Mas caro</span>
            <span class="ahorro-precio">{{ ahorro.peor.precio_por_unidad|precio }}/u</span>
            <span class="ahorro-nombre">{{ ahorro.peor.nombre }}</span>
            <span class="ahorro-tienda">{{ ahorro.peor.tienda }}</span>
          </div>
        </div>
        <div class="ahorro-resumen">
          <p>
            Comprando el mas barato ahorras
            <strong>{{ ahorro.diferencia_por_unidad|precio }}</strong> por panal
            (<strong>{{ "%.0f"|format(ahorro.porcentaje) }}%</strong> menos).
          </p>
          <div class="ahorro-desglose">
            <div class="ahorro-stat">
              <span class="ahorro-stat-valor">{{ ahorro.ahorro_mensual|precio }}</span>
              <span class="ahorro-stat-label">ahorro mensual</span>
              <span class="ahorro-stat-nota">~{{ ahorro.panales_mes }} panales/mes</span>
            </div>
            <div class="ahorro-stat">
              <span class="ahorro-stat-valor">{{ ahorro.ahorro_anual|precio }}</span>
              <span class="ahorro-stat-label">ahorro anual</span>
              <span class="ahorro-stat-nota">12 meses</span>
            </div>
          </div>
        </div>
      </div>
    </div>
    {% endif %}

    <!-- Resultados -->
    {% if hay_filtro and productos %}

      <!-- Tabla (desktop) -->
      <div class="tabla-wrapper">
        <table>
          <colgroup>
            <col class="col-w-check">
            <col class="col-w-tienda">
            <col class="col-w-img">
            <col class="col-w-nombre">
            <col class="col-w-precio">
            <col class="col-w-cantidad">
            <col class="col-w-ppu">
            <col class="col-w-ver">
          </colgroup>
          <thead>
            <tr>
              <th class="col-comparar"></th>
              <th>
                <a href="{{ sort_urls.tienda }}" class="sort-header {{ 'sort-active' if orden_actual == 'tienda' else '' }}">
                  Tienda <span class="sort-arrow">&#9660;</span>
                </a>
              </th>
              <th>Imagen</th>
              <th>
                <a href="{{ sort_urls.marca }}" class="sort-header {{ 'sort-active' if orden_actual == 'marca' else '' }}">
                  Producto <span class="sort-arrow">&#9660;</span>
                </a>
              </th>
              <th>
                <a href="{{ sort_urls.precio }}" class="sort-header {{ 'sort-active' if orden_actual == 'precio' else '' }}">
                  Precio <span class="sort-arrow">&#9660;</span>
                </a>
              </th>
              <th>Cantidad</th>
              <th>
                <a href="{{ sort_urls.precio_por_unidad }}" class="sort-header {{ 'sort-active' if orden_actual == 'precio_por_unidad' else '' }}">
                  Precio/Unidad <span class="sort-arrow">&#9660;</span>
                </a>
              </th>
              <th>Ver</th>
            </tr>
          </thead>
          <tbody>
            {% for p in productos %}
            <tr class="{{ 'fila-mejor' if loop.first else '' }}">
              <td>
                <input type="checkbox" class="comparar-cb"
                  data-producto='{{ {"nombre": p.nombre, "precio": p.precio, "ppu": p.precio_por_unidad, "cantidad": p.tamano_unidades, "tienda": p.tienda, "imagen": p.imagen_url or "", "url": p.url or ""}|tojson }}'
                  onchange="toggleProducto(this, JSON.parse(this.dataset.producto))">
              </td>
              <td class="col-tienda">
                {% if logos_tiendas.get(p.tienda) %}
                  <img src="{{ url_for('static', filename='logos/' + logos_tiendas[p.tienda]) }}" alt="{{ p.tienda }}" class="logo-tienda">
                {% endif %}
                {{ p.tienda }}
              </td>
              <td>
                {% if p.imagen_url %}
                  <img src="{{ p.imagen_url }}" alt="{{ p.nombre }}" class="producto-thumb" loading="lazy">
                {% endif %}
              </td>
              <td class="col-nombre" title="{{ p.nombre }}">
                {% if p.url_detalle %}
                  <a href="{{ p.url_detalle }}" class="link-producto">{{ p.nombre }}</a>
                {% else %}
                  {{ p.nombre }}
                {% endif %}
                {% if loop.first %}
                  <span class="badge-mejor">Mejor precio</span>
                {% endif %}
              </td>
              <td class="col-precio">
                {% if p.descuento_pct %}
                  <span class="precio-lista">{{ p.precio_lista|precio }}</span>
                {% endif %}
                {{ p.precio|precio }}
                {% if p.descuento_pct %}
                  <span class="badge-descuento">-{{ p.descuento_pct }}%</span>
                {% endif %}
              </td>
              <td>{{ p.tamano_unidades or '-' }} un.</td>
              <td class="col-ppu">{{ p.precio_por_unidad|precio }}</td>
              <td>
                {% if p.url %}
                  <a href="{{ p.url }}" target="_blank" rel="noopener" class="link-tienda"
                     onclick="gtag('event','click_producto_tienda',{tienda:'{{ p.tienda }}',producto:'{{ p.nombre|e }}',precio:{{ p.precio or 0 }}})">
                    Ver en tienda &rarr;
                  </a>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Cards (movil) -->
      <div class="cards">
        {% for p in productos %}
        <div class="card {{ 'card-mejor' if loop.first else '' }}">
          <div class="card-header">
            <input type="checkbox" class="comparar-cb"
              data-producto='{{ {"nombre": p.nombre, "precio": p.precio, "ppu": p.precio_por_unidad, "cantidad": p.tamano_unidades, "tienda": p.tienda, "imagen": p.imagen_url or "", "url": p.url or ""}|tojson }}'
              onchange="toggleProducto(this, JSON.parse(this.dataset.producto))">
            {% if p.imagen_url %}
              <img src="{{ p.imagen_url }}" alt="{{ p.nombre }}" class="card-thumb" loading="lazy">
            {% endif %}
            {% if p.url_detalle %}
              <a href="{{ p.url_detalle }}" class="card-nombre link-producto">{{ p.nombre }}</a>
            {% else %}
              <span class="card-nombre">{{ p.nombre }}</span>
            {% endif %}
            {% if loop.first %}
              <span class="badge-mejor">Mejor precio</span>
            {% endif %}
          </div>
          <div class="card-body">
            <div>
              <div class="card-label">Precio/Unidad</div>
              <div class="card-ppu">{{ p.precio_por_unidad|precio }}</div>
            </div>
            <div>
              <div class="card-label">Precio total</div>
              <div class="card-value">
                {% if p.descuento_pct %}
                  <span class="precio-lista">{{ p.precio_lista|precio }}</span>
                {% endif %}
                {{ p.precio|precio }}
                {% if p.descuento_pct %}
                  <span class="badge-descuento">-{{ p.descuento_pct }}%</span>
                {% endif %}
              </div>
            </div>
            <div>
              <div class="card-label">Cantidad</div>
              <div class="card-value">{{ p.tamano_unidades or '-' }} unidades</div>
            </div>
            <div>
              <div class="card-label">Marca</div>
              <div class="card-value">{{ p.marca_normalizada }}</div>
            </div>
          </div>
          <div class="card-footer">
            <span class="card-tienda">
              {% if logos_tiendas.get(p.tienda) %}
                <img src="{{ url_for('static', filename='logos/' + logos_tiendas[p.tienda]) }}" alt="{{ p.tienda }}" class="logo-tienda">
              {% endif %}
              {{ p.tienda }}
            </span>
            {% if p.url %}
              <a href="{{ p.url }}" target="_blank" rel="noopener" class="link-tienda">
                Ver en tienda &rarr;
              </a>
            {% endif %}
          </div>
        </div>
        {% endfor %}
      </div>

    {% elif hay_filtro %}
      <!-- Sin resultados -->
      <div class="empty">
        <div class="empty-icon">&#x1F50D;</div>
        <h3>No se encontraron panales</h3>
        <p>Prueba con otros filtros o una busqueda diferente.</p>
      </div>

    {% else %}
      <!-- Estado inicial con contenido SEO -->
      <div class="empty">
        <div class="empty-icon">&#x1F476;</div>
        <h3>Selecciona una marca, talla o categor&iacute;a</h3>
        <p>BabyAhorro compara precios de pa&ntilde;ales, toallitas h&uacute;medas y f&oacute;rmulas infantiles
           en 9 tiendas: Jumbo, Cruz Verde, Salcobrand, Farmacias Ahumada, Liquimax,
           Distribuidora Pepito, La Pa&ntilde;alera, Pa&ntilde;ales Tin Tin y Santa Isabel.</p>
        <p>Encuentra pa&ntilde;ales Pampers, Huggies, Babysec y m&aacute;s al mejor precio.
           Datos actualizados diariamente.</p>
        {% if ultima_fecha %}
          <p class="empty-fecha">Datos actualizados el {{ ultima_fecha[:10] }}</p>
        {% endif %}
      </div>
    {% endif %}

  </div>

  <!-- Footer -->
  <footer class="footer">
    BabyAhorro &middot; Datos actualizados diariamente
    <br>Hecho con &hearts; por una mam&aacute; primeriza
  </footer>

  <script>
    function actualizarSlider(valor) {
      var label = document.getElementById('precio_max_label');
      var formatted = parseInt(valor).toLocaleString('es-CL');
      label.textContent = '$' + formatted.replace(/,/g, '.');
    }

    // --- Todas / Ninguna tiendas ---
    function seleccionarTiendas(marcar) {
      var checkboxes = document.querySelectorAll('#tiendasGrupo input[type="checkbox"]');
      checkboxes.forEach(function(cb) { cb.checked = marcar; });
    }

    // --- Highlight selects activos ---
    (function() {
      var selects = document.querySelectorAll('.filtro-grupo select');
      function actualizarEstado(sel) {
        if (sel.value !== '') {
          sel.classList.add('filtro-activo');
        } else {
          sel.classList.remove('filtro-activo');
        }
      }
      selects.forEach(function(sel) {
        actualizarEstado(sel);
        sel.addEventListener('change', function() { actualizarEstado(sel); });
      });
    })();

    function toggleDark() {
      document.body.classList.toggle('dark');
      var isDark = document.body.classList.contains('dark');
      localStorage.setItem('darkMode', isDark);
      document.getElementById('darkToggle').innerHTML = isDark ? '&#9788;' : '&#9790;';
    }

    // Set correct icon on load
    (function() {
      var isDark = document.body.classList.contains('dark');
      document.getElementById('darkToggle').innerHTML = isDark ? '&#9788;' : '&#9790;';
    })();

    // --- Filtros en cascada (Categoria -> Marca -> Talla) ---
    (function() {
      var opciones = {{ opciones_filtros|tojson }};
      var categoriaSelect = document.getElementById('categoria');
      var marcaSelect = document.getElementById('marca');
      var tallaSelect = document.getElementById('talla');
      var tallaGrupo = document.getElementById('tallaGrupo');
      var productoSelect = document.getElementById('producto');
      var productoGrupo = document.getElementById('productoGrupo');

      function repoblarSelect(select, valores, valorActual, textoDefault) {
        var prev = valorActual || select.value;
        select.innerHTML = '';
        var optDefault = document.createElement('option');
        optDefault.value = '';
        optDefault.textContent = textoDefault;
        select.appendChild(optDefault);
        var prevExiste = false;
        valores.forEach(function(v) {
          var opt = document.createElement('option');
          opt.value = v;
          opt.textContent = v;
          if (v === prev) {
            opt.selected = true;
            prevExiste = true;
          }
          select.appendChild(opt);
        });
        if (!prevExiste) {
          select.value = '';
        }
      }

      function actualizarCascada(mantenerMarca, mantenerTalla, mantenerProducto) {
        var cat = categoriaSelect.value;
        var datos = opciones[cat] || opciones[''] || {marcas: [], tallas_por_marca: {}};

        // Repoblar marcas
        repoblarSelect(marcaSelect, datos.marcas, mantenerMarca ? undefined : null, 'Todas las marcas');

        if (cat === 'Fórmulas Infantiles') {
          // Ocultar talla, mostrar producto
          tallaGrupo.style.display = 'none';
          tallaSelect.value = '';
          productoGrupo.style.display = '';
          var marca = marcaSelect.value;
          var productosDisponibles = (datos.productos_por_marca && datos.productos_por_marca[marca]) || datos.productos_por_marca[''] || [];
          repoblarSelect(productoSelect, productosDisponibles, mantenerProducto ? undefined : null, 'Todos los productos');
        } else if (cat === 'Toallitas Humedas') {
          tallaGrupo.style.display = 'none';
          tallaSelect.value = '';
          productoGrupo.style.display = 'none';
          productoSelect.value = '';
        } else {
          // Mostrar talla, ocultar producto
          tallaGrupo.style.display = '';
          productoGrupo.style.display = 'none';
          productoSelect.value = '';
          var marca = marcaSelect.value;
          var tallasDisponibles = (datos.tallas_por_marca && datos.tallas_por_marca[marca]) || datos.tallas_por_marca[''] || [];
          repoblarSelect(tallaSelect, tallasDisponibles, mantenerTalla ? undefined : null, 'Todas las tallas');
        }
      }

      categoriaSelect.addEventListener('change', function() {
        actualizarCascada(false, false, false);
      });

      marcaSelect.addEventListener('change', function() {
        actualizarCascada(true, false, false);
      });

      // Inicializar al cargar (respetar valores de URL)
      actualizarCascada(true, true, true);
    })();

    // --- Comparador lado a lado ---
    (function() {
      var seleccionados = [];
      var MAX_COMPARAR = 4;

      // Crear barra flotante
      var barra = document.createElement('div');
      barra.className = 'comparar-bar';
      barra.innerHTML = '<span class="comparar-bar-text"></span><button class="comparar-bar-btn" onclick="abrirComparador()">Comparar</button>';
      barra.style.display = 'none';
      document.body.appendChild(barra);

      // Crear modal
      var modal = document.createElement('div');
      modal.className = 'comparar-modal';
      modal.style.display = 'none';
      document.body.appendChild(modal);

      function actualizarBarra() {
        if (seleccionados.length >= 2) {
          barra.style.display = 'flex';
          barra.querySelector('.comparar-bar-text').textContent = seleccionados.length + ' productos seleccionados';
        } else {
          barra.style.display = 'none';
        }
      }

      function toggleProducto(cb, datos) {
        if (cb.checked) {
          if (seleccionados.length >= MAX_COMPARAR) {
            cb.checked = false;
            return;
          }
          seleccionados.push(datos);
        } else {
          seleccionados = seleccionados.filter(function(p) { return p.nombre !== datos.nombre || p.tienda !== datos.tienda; });
        }
        // Sync checkboxes with same product
        document.querySelectorAll('.comparar-cb').forEach(function(el) {
          var d = JSON.parse(el.dataset.producto);
          var estaSeleccionado = seleccionados.some(function(p) { return p.nombre === d.nombre && p.tienda === d.tienda; });
          el.checked = estaSeleccionado;
        });
        actualizarBarra();
      }

      function formatPrecio(val) {
        if (!val && val !== 0) return '-';
        return '$' + Math.round(val).toLocaleString('es-CL').replace(/,/g, '.');
      }

      window.abrirComparador = function() {
        if (seleccionados.length < 2) return;

        gtag('event', 'comparar_productos', {
          cantidad: seleccionados.length,
          productos: seleccionados.map(function(p) { return p.nombre; }).join(' | ')
        });

        // Find min PPU
        var minPPU = Math.min.apply(null, seleccionados.map(function(p) { return p.ppu || Infinity; }));

        var html = '<div class="comparar-contenido">';
        html += '<div class="comparar-header"><h3>Comparador de productos</h3><button class="comparar-cerrar" onclick="cerrarComparador()">Cerrar</button></div>';

        // Desktop table
        html += '<div class="comparar-tabla-wrapper"><table class="comparar-tabla"><thead><tr><th>Atributo</th>';
        seleccionados.forEach(function() { html += '<th>Producto</th>'; });
        html += '</tr></thead><tbody>';

        // Imagen
        html += '<tr><td>Imagen</td>';
        seleccionados.forEach(function(p) {
          html += '<td>' + (p.imagen ? '<img src="' + p.imagen + '" class="comparar-img">' : '-') + '</td>';
        });
        html += '</tr>';

        // Nombre
        html += '<tr><td>Nombre</td>';
        seleccionados.forEach(function(p) { html += '<td>' + p.nombre + '</td>'; });
        html += '</tr>';

        // Tienda
        html += '<tr><td>Tienda</td>';
        seleccionados.forEach(function(p) { html += '<td>' + p.tienda + '</td>'; });
        html += '</tr>';

        // Precio
        html += '<tr><td>Precio</td>';
        seleccionados.forEach(function(p) { html += '<td>' + formatPrecio(p.precio) + '</td>'; });
        html += '</tr>';

        // Cantidad
        html += '<tr><td>Cantidad</td>';
        seleccionados.forEach(function(p) { html += '<td>' + (p.cantidad || '-') + ' un.</td>'; });
        html += '</tr>';

        // PPU
        html += '<tr><td>Precio/Unidad</td>';
        seleccionados.forEach(function(p) {
          var esMejor = p.ppu && p.ppu === minPPU;
          html += '<td class="' + (esMejor ? 'comparar-mejor' : '') + '">' + formatPrecio(p.ppu) + '</td>';
        });
        html += '</tr>';

        // Diferencia vs mas barato
        html += '<tr><td>Diferencia vs mejor</td>';
        seleccionados.forEach(function(p) {
          if (p.ppu && p.ppu === minPPU) {
            html += '<td class="comparar-mejor">Mejor precio</td>';
          } else if (p.ppu) {
            var diff = p.ppu - minPPU;
            html += '<td>+' + formatPrecio(diff) + '/u</td>';
          } else {
            html += '<td>-</td>';
          }
        });
        html += '</tr>';

        html += '</tbody></table></div>';

        // Mobile cards
        html += '<div class="comparar-cards-movil">';
        seleccionados.forEach(function(p) {
          var esMejor = p.ppu && p.ppu === minPPU;
          html += '<div class="comparar-card-movil' + (esMejor ? ' comparar-card-mejor' : '') + '">';
          if (p.imagen) html += '<img src="' + p.imagen + '" class="comparar-img">';
          html += '<div class="comparar-card-nombre">' + p.nombre + '</div>';
          html += '<div class="comparar-card-detalle"><span>Tienda:</span> ' + p.tienda + '</div>';
          html += '<div class="comparar-card-detalle"><span>Precio:</span> ' + formatPrecio(p.precio) + '</div>';
          html += '<div class="comparar-card-detalle"><span>Cantidad:</span> ' + (p.cantidad || '-') + ' un.</div>';
          html += '<div class="comparar-card-detalle comparar-card-ppu' + (esMejor ? ' comparar-mejor' : '') + '"><span>Precio/Unidad:</span> ' + formatPrecio(p.ppu) + '</div>';
          if (esMejor) {
            html += '<div class="comparar-mejor-badge">Mejor precio</div>';
          } else if (p.ppu) {
            html += '<div class="comparar-card-detalle"><span>Diferencia:</span> +' + formatPrecio(p.ppu - minPPU) + '/u</div>';
          }
          html += '</div>';
        });
        html += '</div>';

        html += '</div>';
        modal.innerHTML = html;
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
      };

      window.cerrarComparador = function() {
        modal.style.display = 'none';
        document.body.style.overflow = '';
      };

      modal.addEventListener('click', function(e) {
        if (e.target === modal) cerrarComparador();
      });

      // Expose for inline handlers
      window.toggleProducto = toggleProducto;
    })();

    // --- Compartir busqueda ---
    function compartirBusqueda(btn) {
      var url = window.location.href;
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(url).then(function() {
          mostrarCopiado(btn);
        });
      } else {
        var input = document.createElement('input');
        input.value = url;
        document.body.appendChild(input);
        input.select();
        document.execCommand('copy');
        document.body.removeChild(input);
        mostrarCopiado(btn);
      }
    }
    function mostrarCopiado(btn) {
      var spanTexto = btn.querySelector('.btn-compartir-texto');
      if (!spanTexto) return;
      var textoOriginal = spanTexto.textContent;
      spanTexto.textContent = 'Copiado!';
      btn.classList.add('btn-compartir--copiado');
      setTimeout(function() {
        spanTexto.textContent = textoOriginal;
        btn.classList.remove('btn-compartir--copiado');
      }, 2000);
    }

    // --- Historial de busquedas recientes ---
    (function() {
      var KEY = 'busquedasRecientes';
      var MAX = 5;
      var form = document.querySelector('.filtros');
      var contenedor = document.getElementById('busquedasRecientes');

      function obtenerHistorial() {
        try {
          return JSON.parse(localStorage.getItem(KEY)) || [];
        } catch(e) { return []; }
      }

      function guardarHistorial(historial) {
        localStorage.setItem(KEY, JSON.stringify(historial));
      }

      function crearLabel() {
        var partes = [];
        var marca = document.getElementById('marca');
        var talla = document.getElementById('talla');
        var categoria = document.getElementById('categoria');
        if (marca && marca.value) partes.push(marca.value);
        if (talla && talla.value) partes.push('Talla ' + talla.value);
        if (categoria && categoria.value) partes.push(categoria.value);
        return partes.join(' - ') || 'Busqueda';
      }

      function renderizarChips() {
        if (!contenedor) return;
        var historial = obtenerHistorial();
        if (historial.length === 0) {
          contenedor.style.display = 'none';
          return;
        }
        contenedor.style.display = 'flex';
        contenedor.innerHTML = '<span class="busquedas-label">Recientes:</span>';
        historial.forEach(function(item) {
          var a = document.createElement('a');
          a.href = item.url;
          a.className = 'busqueda-chip';
          a.textContent = item.label;
          contenedor.appendChild(a);
        });
      }

      if (form) {
        form.addEventListener('submit', function() {
          var cat = document.getElementById('categoria');
          var mar = document.getElementById('marca');
          var tal = document.getElementById('talla');
          gtag('event', 'buscar_productos', {
            categoria: cat ? cat.value : '',
            marca: mar ? mar.value : '',
            talla: tal ? tal.value : ''
          });

          var url = form.action + '?' + new URLSearchParams(new FormData(form)).toString();
          var label = crearLabel();
          if (!label || label === 'Busqueda') return;
          var historial = obtenerHistorial();
          // Remove duplicate
          historial = historial.filter(function(item) { return item.url !== url; });
          historial.unshift({ url: url, label: label });
          if (historial.length > MAX) historial = historial.slice(0, MAX);
          guardarHistorial(historial);
        });
      }

      renderizarChips();
    })();

    // --- URLs amigables: interceptar form submit ---
    (function() {
      var form = document.getElementById('formBuscar');
      if (!form) return;
      var catSlugMap = {"Pa\u00f1ales": "panales", "Pa\u00f1ales de Agua": "panales-de-agua", "Toallitas Humedas": "toallitas", "F\u00f3rmulas Infantiles": "formulas"};
      var slugifyMap = {};
      {% for marca in marcas %}
      slugifyMap["{{ marca }}"] = "{{ slugify(marca) }}";
      {% endfor %}

      function toSlug(text) {
        if (!text) return '';
        if (slugifyMap[text]) return slugifyMap[text];
        return text.toLowerCase().normalize('NFKD').replace(/[\u0300-\u036f]/g, '')
          .replace(/\+/g, '-plus').replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '');
      }

      form.addEventListener('submit', function(e) {
        var cat = document.getElementById('categoria').value;
        var marca = document.getElementById('marca').value;
        var talla = document.getElementById('talla').value;
        var catSlug = catSlugMap[cat];

        if (catSlug) {
          e.preventDefault();
          var path = '/' + catSlug + '/';
          if (marca) {
            path += toSlug(marca) + '/';
            if (talla) {
              path += 'talla-' + toSlug(talla) + '/';
            }
          }
          // Append remaining query params (tiendas, precio_max, orden)
          var params = new URLSearchParams();
          var formData = new FormData(form);
          formData.forEach(function(val, key) {
            if (['categoria', 'marca', 'talla'].indexOf(key) === -1 && val) {
              params.append(key, val);
            }
          });
          var qs = params.toString();
          window.location.href = path + (qs ? '?' + qs : '');
        }
        // else: let the normal form submission proceed with query params
      });
    })();

    // --- Service Worker ---
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/static/sw.js').catch(function() {});
    }
  </script>

</body>
</html>
